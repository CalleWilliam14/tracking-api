# Variables
$projectPath = "C:\Users\Lenovo.ANDRES\source\repos\tracking-api\TrackingApi"
$publishPath = "C:\Deploy\TrackingAPI"
$siteName = "TrackingAPI"
$appPool = "TrackingAPIAppPool"
$port = 8080

# 1. Publicar el proyecto
dotnet publish $projectPath -c Release -o $publishPath

# 2. Importar el módulo de IIS
Import-Module WebAdministration

# 3. Crear el Application Pool si no existe
if (-not (Get-WebAppPoolState -Name $appPool -ErrorAction SilentlyContinue)) {
    New-WebAppPool -Name $appPool
}

# 4. Crear el sitio en IIS si no existe
if (-not (Get-Website -Name $siteName -ErrorAction SilentlyContinue)) {
    New-Website -Name $siteName -Port $port -PhysicalPath $publishPath -ApplicationPool $appPool
} else {
    # Si ya existe, solo actualiza la ruta física
    Set-ItemProperty "IIS:\Sites\$siteName" -Name physicalPath -Value $publishPath
}

# 5. Reiniciar el sitio
Restart-WebAppPool $appPool
Restart-Website $siteName

Write-Host "Despliegue completado en IIS para $siteName en el puerto $port"